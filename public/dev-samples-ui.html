<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dev Samples Viewer</title>

    <!-- Tailwind Play CDN for quick styling (dev only) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React / ReactDOM from unpkg -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel in-browser to compile JSX (dev only, not for production) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* small fix for code blocks */
        pre {
            white-space: pre-wrap;
            margin: 0;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
            font-size: 12px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- The DevSamplesViewer component code (JSX) -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Minimalized DevSamplesViewer adapted from your component
        function DevSamplesViewer({ apiBase = '/dev-samples' }) {
            const DEFAULT_TABLES = [
                'college_info',
                'major_info',
                'college_admission_score',
                'college_plan',
                'school_enrollment',
                'users',
                'student_score'
            ];
            const [token, setToken] = useState('');
            const [tables, setTables] = useState(DEFAULT_TABLES);
            const [sampleSize, setSampleSize] = useState(5);
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [selectedTable, setSelectedTable] = useState(DEFAULT_TABLES[0] || null);
            const rowsPerPage = 10;
            const [rowPageIndex, setRowPageIndex] = useState(0);

            useEffect(() => {
                if (data && (!selectedTable || !data[selectedTable])) {
                    const keys = Object.keys(data || {});
                    setSelectedTable(keys.length ? keys[0] : null);
                }
            }, [data]);

            function toggleTable(t) {
                setData(null); setError(null); setRowPageIndex(0);
                setTables(prev => prev.includes(t) ? prev.filter(x => x !== t) : [...prev, t]);
            }

            async function fetchSamples() {
                setLoading(true); setError(null); setData(null);
                try {
                    const params = new URLSearchParams();
                    params.set('sampleSize', String(sampleSize));
                    params.set('tables', tables.join(','));
                    const url = `${apiBase}?${params.toString()}`;
                    const headers = {};
                    if (token) headers['Authorization'] = `Bearer ${token}`;
                    const resp = await fetch(url, { headers });
                    if (!resp.ok) { const txt = await resp.text(); throw new Error(`${resp.status} ${resp.statusText} â€” ${txt}`); }
                    const json = await resp.json();
                    setData(json.data || {});
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }

            function downloadCsvForTable(tableName) {
                if (!data || !data[tableName]) return;
                const { columns = [], samples = [] } = data[tableName];
                const rows = [columns, ...samples.map(r => columns.map(c => JSON.stringify(r[c] ?? '')))]
                    .map(r => r.map(cell => `${cell}`).join(',')).join('\n');
                const blob = new Blob([rows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `${tableName}_samples.csv`; a.click(); URL.revokeObjectURL(url);
            }

            function renderCell(v) {
                if (v === null || v === undefined) return <span className="text-gray-400">NULL</span>;
                if (typeof v === 'object') return <pre>{JSON.stringify(v, null, 2)}</pre>;
                return <span>{String(v)}</span>;
            }

            return (
                <div className="p-6 max-w-7xl mx-auto">
                    <h2 className="text-2xl font-bold mb-4">Dev Samples Viewer</h2>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="md:col-span-2 bg-white p-4 rounded shadow">
                            <div className="flex gap-3 items-end">
                                <div className="flex-1">
                                    <label className="block text-sm font-medium">JWT Token (optional)</label>
                                    <input value={token} onChange={e => setToken(e.target.value)} className="mt-1 block w-full border rounded p-2" placeholder="Paste token here" />
                                </div>
                                <div className="w-36">
                                    <label className="block text-sm font-medium">Sample size</label>
                                    <input type="number" min="1" max="50" value={sampleSize} onChange={e => setSampleSize(Number(e.target.value) || 5)} className="mt-1 block w-full border rounded p-2" />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={fetchSamples} className="px-4 py-2 bg-indigo-600 text-white rounded">Fetch samples</button>
                                    <button onClick={() => { setData(null); setError(null); }} className="px-4 py-2 border rounded">Clear</button>
                                </div>
                            </div>

                            <div className="mt-4">
                                <div className="text-sm text-gray-600 mb-2">Select tables</div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    {DEFAULT_TABLES.map(t => (
                                        <label key={t} className="inline-flex items-center gap-2">
                                            <input type="checkbox" checked={tables.includes(t)} onChange={() => toggleTable(t)} className="form-checkbox" />
                                            <span className="text-sm">{t}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded shadow">
                            <div className="text-sm text-gray-600">Status</div>
                            <div className="mt-2">
                                <div>Loading: <strong>{String(loading)}</strong></div>
                                <div>Tables requested: <strong>{tables.length}</strong></div>
                                <div>Selected table: <strong>{selectedTable || '-'}</strong></div>
                                {error && <div className="mt-2 text-sm text-red-600">Error: {error}</div>}
                            </div>
                        </div>
                    </div>

                    {data ? (
                        <div className="bg-gray-50 p-4 rounded">
                            <div className="flex gap-6">
                                <div className="w-56">
                                    <div className="text-sm font-medium mb-2">Tables</div>
                                    <div className="bg-white rounded border p-2 h-[480px] overflow-auto">
                                        {Object.keys(data).map(name => {
                                            const meta = data[name] || {};
                                            return (
                                                <div key={name} onClick={() => { setSelectedTable(name); setRowPageIndex(0); }} className={`p-2 rounded cursor-pointer hover:bg-gray-100 ${selectedTable === name ? 'bg-indigo-50' : ''}`}>
                                                    <div className="font-medium">{name}{meta.rowCount ? ` (${meta.rowCount})` : ''}</div>
                                                    <div className="text-xs text-gray-600">cols: {meta.columns ? meta.columns.length : 0}, samples: {meta.samples ? meta.samples.length : 0}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="flex-1">
                                    <div className="flex items-center justify-between mb-3">
                                        <div>
                                            <h3 className="text-lg font-semibold">{selectedTable}</h3>
                                            <div className="text-xs text-gray-500">Showing sample rows (client page {rowPageIndex + 1})</div>
                                        </div>
                                        <div>
                                            <button onClick={() => downloadCsvForTable(selectedTable)} className="px-3 py-1 bg-green-600 text-white rounded text-sm">Download CSV</button>
                                        </div>
                                    </div>

                                    <div className="overflow-auto border rounded bg-white">
                                        {selectedTable && data[selectedTable] ? (
                                            <div className="p-2">
                                                <table className="min-w-full text-sm">
                                                    <thead>
                                                        <tr className="bg-gray-50">
                                                            {data[selectedTable].columns.map(c => <th key={c} className="px-3 py-2 text-left">{c}</th>)}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {(data[selectedTable].samples.slice(rowPageIndex * rowsPerPage, (rowPageIndex + 1) * rowsPerPage)).map((r, idx) => (
                                                            <tr key={idx} className="border-t">
                                                                {data[selectedTable].columns.map(c => <td key={c} className="px-3 py-2 align-top">{renderCell(r[c])}</td>)}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>

                                                <div className="flex items-center justify-between mt-3">
                                                    <div className="text-xs text-gray-600">Showing {Math.min(data[selectedTable].samples.length, rowsPerPage)} of {data[selectedTable].samples.length} sample rows</div>
                                                    <div className="flex items-center gap-2">
                                                        <button disabled={rowPageIndex === 0} onClick={() => setRowPageIndex(Math.max(0, rowPageIndex - 1))} className="px-2 py-1 border rounded disabled:opacity-50">Prev</button>
                                                        <button disabled={(rowPageIndex + 1) * rowsPerPage >= data[selectedTable].samples.length} onClick={() => setRowPageIndex(rowPageIndex + 1)} className="px-2 py-1 border rounded disabled:opacity-50">Next</button>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : <div className="p-4">No data for selected table.</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : <div className="text-gray-500">No data loaded. Click "Fetch samples" to load.</div>}
                </div>
            );
        }

        function renderCell(v) {
            if (v === null || v === undefined) return <span className="text-gray-400">NULL</span>;
            if (typeof v === 'object') return <pre>{JSON.stringify(v, null, 2)}</pre>;
            return <span>{String(v)}</span>;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<DevSamplesViewer />);
    </script>
</body>

</html>